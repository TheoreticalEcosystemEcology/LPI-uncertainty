---
title: 'Source(s) of bias in the LPI calculation'
output: html_document
---

A demonstration with the simplest scenario in the study: declines, stable, and growth without covariance or process error.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(dplyr)
library(tidyr)
library(ggplot2)
library(readr)
library(here)

theme_set(theme_linedraw())

pal_compare <- c("without GAM" = "blue", 
                 "with GAM" = "red", 
                 "truth" = "black")

temp <- c(paste0("scenario1", LETTERS[1:3]), paste0("scenario2", LETTERS[1:3]), paste0("scenario3", LETTERS[1:3]))
```

```{r load-results, echo = FALSE}
## TRUE ABUNDANCES ##

Ntrue <- lapply(temp, function(x) {readRDS(here::here(paste0("outputs/",x,"_true.RDS")))})
names(Ntrue) <- temp
Ntrue <- bind_rows(Ntrue, .id = "scenario")
colnames(Ntrue)[6] <- "N_true"

## GROWTH RATES ####

# import the lambdas (dt) from log-ratio of without GAM population sizes
df <- lapply(temp, function(x) {readRDS(here::here(paste0("outputs/",x,"_l_dtchain.RDS")))})
names(df) <- temp
df <- bind_rows(df, .id = "scenario")

# import lambdas from the rlpi calculation ("with GAM")
lambdas <- lapply(temp, function(x) {
  read_csv(here::here(paste0("outputs/rlpi/", x, "_pops_lambda.csv"))) %>%
    pivot_longer(cols = 4:ncol(.), names_to = "time", values_to = "dt_rlpi")
  }
  )
names(lambdas) <- temp
lambdas <- bind_rows(lambdas, .id = "scenario")
lambdas$time <- as.integer(lambdas$time) - 1969


# import lambdas from the rlpi calculation ("with GAM")
truelambdas <- lapply(temp, function(x) {
  read_csv(here::here(paste0("outputs/rlpi/",x,"_true_pops_lambda.csv"))) %>%
    pivot_longer(cols = 4:ncol(.), names_to = "time", values_to = "dt_rlpi_true")
  }
  )
names(truelambdas) <- temp
truelambdas <- bind_rows(truelambdas, .id = "scenario")
truelambdas$time <- as.integer(truelambdas$time) - 1969

# add these lambdas to the dataset
df$dt_rlpi <- lambdas$dt_rlpi
df$dt_rlpi_true <- truelambdas$dt_rlpi_true
df$N_true <- Ntrue$N_true

df[which(df$time == 1), "dt_chain"] <- 0
df[which(df$time == 1), "dt_rlpi"] <- 0
df[which(df$time == 1), "dt_rlpi_true"] <- 0
```


## Step 1: Population time series

```{r}
ggplot(df, aes(x = time, y = N, group = popID, col = set)) +
  geom_line(lwd = .2) +
  geom_line(aes(y = N_true), col = "black") +
  facet_wrap(~scenario)
```


## Step 2:  Smoothing time series

```{r, results='hide'}
# calculate GAMs (code adapted from CalcLPI.R lines 215-220ish)
gam_lpi <- function(x){
  PopNLog <- log(x$N)
  YearPop = 1:11
  SmoothParm = round(length(x$N)/2)
  model <- mgcv::gam(PopNLog ~ s(YearPop, k = SmoothParm), fx = TRUE)
}

pops <- df %>% group_by(scenario, popID) %>% group_split()
smoothed <- lapply(pops, gam_lpi)

# apply model appraisal to check validity
pdf(file = here("outputs/gam_Appraisals.pdf"))
  lapply(smoothed, gratia::appraise)
dev.off()

# extract fitted values and residuals
df$N_fitted <- lapply(smoothed, fitted.values) %>% unlist()
df$N_resids <- lapply(smoothed, resid) %>% unlist()
```

## Summary {.tabset .tabset-pills}

### Smoothed time series

```{r}
ggplot(df, aes(group = popID, col = set)) +
  geom_line(aes(x = time, y = log(N)), lwd = .1, alpha = .5) +
  geom_line(aes(x = time, y =  N_fitted), lwd = .2) +
  facet_wrap(~scenario) +
  labs(y = "Abundance (log)", x = "", title = "Smoothed time series")
```

### Fit vs. data

```{r}
ggplot(df) +
  geom_density(aes(x = N, fill = "Raw"), alpha = .2, lwd = .1) +
  geom_density(aes(x = exp(N_fitted), fill = "Fitted (GAM)"), alpha = .2, lwd = .1) +
    geom_density(aes(x = N_true, fill = "Fitted (GAM)"), alpha = 0, lwd = .1, lty = 2) +
  facet_wrap(~scenario, scales = "free") +
  labs(x = "Abundance", fill = "Source", title = "Fitted abundances vs. without GAM data")
```

### Residuals

```{r}
ggplot(df) +
  geom_density(aes(x = N_resids), alpha = .2, lwd = .1) +
  facet_wrap(~scenario, scales = "free") +
  labs(x = "Residuals", fill = "Scenario", title = "GAM residuals")
```

## {-}

## Step 3: Calculating growth rates (log-ratio)

## Summary {.tabset .tabset-pills}

### Growth rates

```{r}
ggplot(data = df, aes(x = time, group = popID, col = set))+
  geom_line(aes(y = dt_rlpi_true), 
            alpha = 1, lwd = .5, lty = 2) +
  geom_line(aes(y = dt_chain), 
            alpha = .5, lwd = .1) +
  geom_line(aes(y = dt_rlpi), 
            alpha = 1, lwd = .1) +
  scale_fill_manual(values = pal_compare) + 
  #scale_color_manual(values = pal_compare) +
  facet_wrap(~scenario) +
  labs(y = "Annual growth rate", x ="")
```

### Compare distributions

```{r}
df_l <- pivot_longer(df, cols = c("dt_rlpi", "dt_chain", "dt_rlpi_true"),
                     names_to = "dt_source",
                     values_to = "dt_value")

# get mean dt true rlpi for comparison between density ridges
df_means <- df %>% group_by(scenario) %>%
  summarise(geomean_dt = (EnvStats::geoMean(10^(dt_rlpi_true))),
            mean_dt = mean(10^dt_rlpi_true))

library(ggridges)
df_l %>%
  ggplot()+  
  geom_density_ridges(aes(x = 10^(dt_value), y = dt_source, 
                          fill = dt_source), 
                      alpha = .7, lwd = .4, scale = 0.85,
                      quantile_lines = TRUE, quantile_fun = function(x,...)EnvStats::geoMean(x))+
  geom_vline(data = df_means, aes(xintercept = geomean_dt), lty = 2) +
  #geom_vline(data = df_means, aes(xintercept = mean_dt), lty = 3) +
  facet_wrap(~scenario) +
  labs(x = "Annual growth rate", fill = "Method", y = "") +
  coord_cartesian(xlim = c(0.5,1.5)) +
  scale_fill_viridis_d(labels = c("without GAM", "with GAM  (rlpi)", "true (rlpi)")) + scale_color_viridis_d()
```

### Boxplot comparison

```{r}
test <- pivot_longer(df, 
                     names_to = "source", values_to = "DT", 
                     cols = c("dt_rlpi", "dt_chain"))
ggplot(test) + 
  geom_boxplot(aes(x = source, y = DT)) + 
  facet_wrap(~scenario) +
  labs(y = "Growth rate", x = "")
```


## {-}

## Step 4: Taking the mean growth rate per time step

```{r}
#### MEAN DT (from rlpi) ####

dtbar <- lapply(temp, function(x) {
  read_csv(here::here(paste0("outputs/rlpi/",x,"_pops_dtemp.csv"))) %>%
    pivot_longer(cols = everything(), names_to = "time", values_to = "mu_rlpi")
  }
  )
names(dtbar) <- temp
dtbar <- bind_rows(dtbar, .id = "scenario")
dtbar$time <- as.integer(dtbar$time) - 1969
dtbar[which(dtbar$time == 1), "mu_rlpi"] <- 0


##### Mean true DT #####

dtbar_true <- lapply(temp, function(x) {
  read_csv(here::here(paste0("outputs/rlpi/",x,"_true_pops_dtemp.csv"))) %>%
    pivot_longer(cols = everything(), names_to = "time", values_to = "mu_rlpi_true")
  }
  )
names(dtbar_true) <- temp
dtbar_true <- bind_rows(dtbar_true, .id = "scenario")
dtbar_true$time <- as.integer(dtbar_true$time) - 1969
dtbar_true[which(dtbar_true$time == 1), "mu_rlpi_true"] <- 0

# get geometric mean dt of each distribution
means <- 
  group_by(df, scenario, pop, time) %>%
  # per "species"
  summarise(mu_raw = EnvStats::geoMean(exp(dt_chain), na.rm = TRUE) 
            ) %>% ungroup() %>%
  #"overall"
  group_by(scenario, time) %>%
  summarise(mu_raw = log(EnvStats::geoMean(mu_raw, na.rm = TRUE)))
means <- inner_join(means, dtbar)
means <- inner_join(means, dtbar_true)
```

## Summary {.tabset .tabset-pills}

### Mean growth rate over time

```{r}
# the mean across populations + species is where the disconnect happens!!!!!!
ggplot(means, aes(x = time))+
  geom_line(aes(y = mu_raw, col = "without GAM")) +
  geom_line(aes(y = mu_rlpi, col = "with GAM")) +
  geom_line(aes(y = mu_rlpi_true, col = "truth")) +
  scale_fill_manual(values = pal_compare) + 
  scale_color_manual(values = pal_compare) +
  facet_wrap(~scenario) +
  labs(col = "Source", fill = "Source", x = "Annual growth rate")
```

### Compare distributions

```{r}
toplot = means %>% filter(time != 1) %>% 
  rename(no_error = mu_rlpi_true,
         with_error = mu_rlpi) %>%
  subset(select = -c(mu_raw)) %>%
  pivot_longer(cols = c(no_error, with_error),
               names_to = "mu_type", 
               values_to = "mu") 

A <- ggplot(data = filter(toplot, 
                     scenario %in% c("scenario1A", 
                                     "scenario2A", 
                                     "scenario3A")), aes(x = time)) +
  stat_density_ridges(aes(y = mu_type, x = mu, fill = mu_type),
                      alpha = 0.7,
                      quantile_lines = TRUE, 
                      quantile_fun = function(x,...) 
                        log10(EnvStats::geoMean(10^x))) + 
  facet_wrap(~scenario, dir = "v") +
  labs(col = "Source", fill = "Source", x = "Annual growth rate", y = "") +
  theme(legend.position = "none")

B <- ggplot(data = filter(toplot, 
                     scenario %in% c("scenario1B", 
                                     "scenario2B", 
                                     "scenario3B")), aes(x = time)) +
  stat_density_ridges(aes(y = mu_type, x = mu, fill = mu_type),
                      alpha = 0.7,
                      quantile_lines = TRUE, 
                      quantile_fun = function(x,...) 
                        log10(EnvStats::geoMean(10^x))) + 
  facet_wrap(~scenario, dir = "v") +
  labs(col = "Source", fill = "Source", x = "Annual growth rate", y = "")+
  theme(legend.position = "none") +
  coord_cartesian(xlim = c(-0.01, 0.01))

C <- ggplot(data = filter(toplot, 
                     scenario %in% c("scenario1C", 
                                     "scenario2C", 
                                     "scenario3C")), aes(x = time)) +
  stat_density_ridges(aes(y = mu_type, x = mu, fill = mu_type),
                      alpha = 0.7,
                      quantile_lines = TRUE, 
                      quantile_fun = function(x,...) 
                        log10(EnvStats::geoMean(10^x))) + 
  facet_wrap(~scenario, dir = "v") +
  labs(col = "Source", fill = "Source", x = "Annual growth rate", y = "")+
  theme(legend.position = "none")
A + B + C
```

### Boxplot comparison

```{r}
test <- pivot_longer(means, 
                     names_to = "source", values_to = "mu", 
                     cols = c("mu_rlpi", "mu_raw", "mu_rlpi_true"))
ggplot(test) + 
  geom_boxplot(aes(x = source, y = mu)) + 
  facet_wrap(~scenario) +
  labs(y = "Mean growth rate", x = "")
```

## {-}

## Calculating the Living Planet Index (baseline = 1)

```{r}
# function to calculate LPI from mean dt
calclpi <- function(dt){
  # calculate index value
  lpi = c(1) # initial value is 1 
  for(i in 2:length(dt)){
    lpi[i] <- lpi[i-1]*10^dt[i] }
  return(lpi)
}

means_ls <- means %>% 
  group_by(scenario) %>%
  group_split() %>% 
  lapply(tibble::as_data_frame)

for(i in 1:length(means_ls)){
  means_ls[[i]]$lpi_raw <- calclpi(means_ls[[i]]$mu_raw)
}
means <- bind_rows(means_ls)


all_results <- readRDS("~/Documents/GitHub/LPI-sensitivity/outputs/all_results.RDS")
finals <- left_join(means, all_results)
```

```{r}
ggplot(finals, aes(x = time)) +
  geom_line(aes(y = lpi_raw, col = "without GAM")) +
  geom_line(aes(y = LPI_final, col = "with GAM")) +
  geom_line(aes(y = LPI_final_true, col = "black"), lty = 2) +
  facet_wrap(~scenario) +
  scale_color_manual(values = pal_compare)
```

